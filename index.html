<!DOCTYPE html>
<html lang="it">
<head>
    <!-- Tutto il tuo CSS rimane invariato -->
    <style>
        /* Tutto il tuo CSS esistente */
    </style>
</head>
<body>
    <!-- Tutto il tuo HTML rimane invariato -->
    <div class="container">
        <!-- Tutto il contenuto HTML esistente -->
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Configurazione iniziale
        const screens = {
            home: document.getElementById('homeScreen'),
            createRoom: document.getElementById('createRoomScreen'),
            joinRoom: document.getElementById('joinRoomScreen'),
            lobby: document.getElementById('lobbyScreen'),
            game: document.getElementById('gameScreen')
        };

        // Elementi UI (tutti i tuoi elementi esistenti)

        // Stato del gioco
        let socket;
        let isHost = false;
        let currentPlayers = [];
        let myName = '';
        let roomCode = '';
        let isImpostor = false;
        let gameInterval;
        let timerInterval;
        let currentRound = 1;
        let innocentPoints = 0;
        let impostorPoints = 0;
        let gameSettings = {
            difficulty: 'medium',
            songDuration: 45,
            roundsToWin: 5
        };

        // Funzioni di utilit√†
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            screens[screenId].classList.add('active');
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 5; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function updatePlayerList(players) {
            currentPlayers = players;
            playerList.innerHTML = '';
            playerCount.textContent = players.length;
            
            if (isHost) {
                startGameBtn.disabled = players.length < 3;
            }
            
            players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'player-name';
                nameSpan.textContent = player.name;
                
                const roleSpan = document.createElement('span');
                if (player.isHost) {
                    roleSpan.className = 'player-host';
                    roleSpan.textContent = 'üëë Host';
                } else if (player.isImpostor) {
                    roleSpan.className = 'badge badge-danger';
                    roleSpan.textContent = 'IMPOSTORE';
                } else {
                    roleSpan.className = 'badge badge-success';
                    roleSpan.textContent = 'INNOCENTE';
                }
                
                playerItem.appendChild(nameSpan);
                playerItem.appendChild(roleSpan);
                playerList.appendChild(playerItem);
            });
        }

        function showNotification(message, type = 'info') {
            notificationText.textContent = message;
            notification.className = 'notification';
            
            switch (type) {
                case 'success':
                    notification.classList.add('notification-success');
                    notificationIcon.textContent = '‚úÖ';
                    break;
                case 'error':
                    notification.classList.add('notification-error');
                    notificationIcon.textContent = '‚ùå';
                    break;
                case 'warning':
                    notification.classList.add('notification-warning');
                    notificationIcon.textContent = '‚ö†Ô∏è';
                    break;
                default:
                    notificationIcon.textContent = '‚ÑπÔ∏è';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function startTimer(duration) {
            let timeLeft = duration;
            timerDisplay.textContent = timeLeft;
            progressBar.style.width = '100%';
            
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                progressBar.style.width = `${(timeLeft / duration) * 100}%`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        // MODIFICHE PRINCIPALI: Migliorata la gestione della connessione e creazione stanza
        function connectToServer() {
            return new Promise((resolve, reject) => {
                // Se il socket esiste gi√† e √® connesso, risolvi immediatamente
                if (socket && socket.connected) {
                    resolve(socket);
                    return;
                }
                
                // Altrimenti crea una nuova connessione
                socket = io({
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    timeout: 5000
                });

                // Timeout per la connessione
                const connectionTimeout = setTimeout(() => {
                    reject(new Error('Timeout nella connessione al server'));
                    socket.disconnect();
                }, 10000);

                socket.on('connect', () => {
                    clearTimeout(connectionTimeout);
                    console.log('Connesso al server');
                    resolve(socket);
                });

                socket.on('connect_error', (err) => {
                    clearTimeout(connectionTimeout);
                    console.error('Errore di connessione:', err);
                    reject(err);
                });
            });
        }

        // Funzione migliorata per creare una stanza
        async function createRoom() {
            const name = hostNameInput.value.trim();
            if (!name) {
                showNotification('Inserisci il tuo nome', 'error');
                return;
            }

            try {
                // Mostra un feedback all'utente
                startRoomBtn.disabled = true;
                startRoomBtn.innerHTML = '<i class="icon">‚è≥</i> Creazione in corso...';
                
                // Connetti al server
                await connectToServer();
                
                const settings = {
                    difficulty: gameDifficultySelect.value,
                    songDuration: parseInt(songDurationSelect.value),
                    roundsToWin: parseInt(roundsToWinSelect.value)
                };

                // Emetti l'evento per creare la stanza
                socket.emit('createRoom', {
                    hostName: name,
                    settings: settings
                });
                
            } catch (error) {
                console.error('Errore nella creazione della stanza:', error);
                showNotification('Errore di connessione al server. Riprova pi√π tardi.', 'error');
                startRoomBtn.disabled = false;
                startRoomBtn.innerHTML = '<i class="icon">üöÄ</i> Crea Stanza';
            }
        }

        // Resto del codice rimane invariato...
        function getDifficultyName(difficulty) {
            switch (difficulty) {
                case 'easy': return 'Facile';
                case 'medium': return 'Medio';
                case 'hard': return 'Difficile';
                default: return difficulty;
            }
        }

        // Event listeners
        createRoomBtn.addEventListener('click', () => {
            showScreen('createRoom');
        });

        joinRoomBtn.addEventListener('click', () => {
            showScreen('joinRoom');
        });

        howToPlayBtn.addEventListener('click', () => {
            howToPlayModal.style.display = 'flex';
        });

        closeHowToPlay.addEventListener('click', () => {
            howToPlayModal.style.display = 'none';
        });

        closeModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                button.closest('.modal').style.display = 'none';
            });
        });

        window.addEventListener('click', (event) => {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        });

        // MODIFICATO: Sostituito con la nuova funzione createRoom
        startRoomBtn.addEventListener('click', createRoom);

        joinGameBtn.addEventListener('click', async () => {
            const name = playerNameInput.value.trim();
            const code = roomCodeInput.value.trim().toUpperCase();

            if (!name) {
                showNotification('Inserisci il tuo nome', 'error');
                return;
            }

            if (!code || code.length !== 5) {
                showNotification('Inserisci un codice stanza valido (5 caratteri)', 'error');
                return;
            }

            try {
                joinGameBtn.disabled = true;
                joinGameBtn.innerHTML = '<i class="icon">‚è≥</i> Connessione in corso...';
                
                await connectToServer();
                
                socket.emit('joinRoom', {
                    playerName: name,
                    roomCode: code
                });
                
            } catch (error) {
                console.error('Errore nel join:', error);
                showNotification('Errore di connessione al server. Riprova pi√π tardi.', 'error');
                joinGameBtn.disabled = false;
                joinGameBtn.innerHTML = '<i class="icon">üéß</i> Unisciti al Gioco';
            }
        });

        startGameBtn.addEventListener('click', () => {
            if (socket && socket.connected) {
                socket.emit('startGame', { roomCode: roomCode });
            } else {
                showNotification('Errore: connessione al server persa', 'error');
            }
        });

        leaveLobbyBtn.addEventListener('click', () => {
            if (socket && socket.connected) {
                socket.emit('leaveRoom', { roomCode: roomCode });
            }
            showScreen('home');
            roomCode = '';
        });

        copyRoomCodeBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(roomCode)
                .then(() => {
                    showNotification('Codice copiato negli appunti!', 'success');
                })
                .catch(() => {
                    showNotification('Impossibile copiare il codice', 'error');
                });
        });

        lobbySettingsBtn.addEventListener('click', () => {
            lobbyDifficultySelect.value = gameSettings.difficulty;
            lobbySongDurationSelect.value = gameSettings.songDuration.toString();
            lobbyRoundsToWinSelect.value = gameSettings.roundsToWin.toString();
            
            lobbySettingsModal.style.display = 'flex';
        });

        saveLobbySettingsBtn.addEventListener('click', () => {
            const newSettings = {
                difficulty: lobbyDifficultySelect.value,
                songDuration: parseInt(lobbySongDurationSelect.value),
                roundsToWin: parseInt(lobbyRoundsToWinSelect.value)
            };

            socket.emit('updateSettings', {
                roomCode: roomCode,
                settings: newSettings
            });

            lobbySettingsModal.style.display = 'none';
        });

        // Inizializza la connessione al server
        connectToServer().catch(err => {
            console.error('Connessione iniziale fallita:', err);
        });

        // Gestione audio su mobile
        document.addEventListener('click', () => {
            if (audioPlayer.paused && audioPlayer.src) {
                audioPlayer.play().catch(e => console.log('Autoplay non consentito'));
            }
        }, { once: true });

        // Aggiunto: Reimposta il pulsante se la pagina viene ricaricata
        window.addEventListener('beforeunload', () => {
            if (socket && socket.connected) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
